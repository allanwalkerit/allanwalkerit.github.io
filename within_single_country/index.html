<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Within Single Country</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />

<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0px; bottom: 0; width: 100%; }
.map-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0);
            margin-right: 20px;
            font-family: Arial, sans-serif;
            overflow: auto;
            border-radius: 3px;
            z-index: 1;
        }
#features {
            top: 0;
            margin-top: 20px;
        }
</style>
</head>

<body>
<div class="map-overlay" id="features"><select id="selector">
    <option selected disabled hidden>Select Country</option>
    <option value="US">US</option>
    <option value="FR">France</option>
    <option value="MX">Mexico</option>
</select>
</div>
<div id="map"></div>
</body>


<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiYWxsYW53YWxrZXIiLCJhIjoiY2phbHVlOHQ4MnZscDMycGJoaTdiaHRxOCJ9.OYLAoMVg6e3Ih4r65WJuvA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        zoom: 1.5,
        center: [0,0]
    });

map.on('style.load', function() {
map.addSource('Boundaries', {
  type: 'vector',
  url: 'mapbox://mapbox.boundaries-adm0-v3'
});


map.addLayer({
'id': 'countriespolygon',
'type': 'fill',
'source': 'Boundaries',
'source-layer': 'boundaries_admin_0',
'layout': {},
'paint': {
'fill-color': 'white',
'fill-opacity': 0
}
});


map.once('style.load', (ev) => {
$( "#selector" ).change(function() {
var val = (this.value);
var countryfeatures = map.querySourceFeatures('Boundaries', {sourceLayer: 'boundaries_admin_0', filter: ["all",["any",["==", "all", ["get", "worldview"]],["in", "US", ["get", "worldview"]]],['!',['has','dispute']]]});

var features = map.querySourceFeatures('Boundaries', {sourceLayer: 'boundaries_admin_0', filter: ["==", "iso_3166_1", val]});

var uniquefeatures = [];
$.each(features, function(i, el){
    if($.inArray(el, uniquefeatures) === -1) uniquefeatures.push(el);
});

var selectedgeom = uniquefeatures[0].geometry;

var uniquecountryfeatures = [];
$.each(countryfeatures, function(i, el){
    if($.inArray(el, uniquecountryfeatures) === -1) uniquecountryfeatures.push(el);
});


if (map.getLayer('cookiecutter')){
map.removeLayer('cookiecutter');
map.removeSource('cookiecutter');
}

if (map.getLayer('mask')){
map.removeLayer('mask');
map.removeSource('mask');
}

if (map.getLayer('ne_populatedplaces')){
map.removeLayer('ne_populatedplaces');
map.removeSource('ne_populatedplaces');
}

if (map.getLayer('streets')){
map.removeLayer('streets');
map.removeSource('streets');
}

map.addSource("cookiecutter", {
     "type": "geojson",
     "data": {
       "type": "FeatureCollection",
       "features": uniquecountryfeatures
     }
   });

map.addSource("mask", {
     "type": "geojson",
     "data": {
       "type": "FeatureCollection",
       "features": uniquecountryfeatures
     }
   });

map.addLayer({
'id': 'cookiecutter',
'type': 'fill',
"filter": ["==", "iso_3166_1", val],
'source': 'cookiecutter',
'layout': {},
'paint': {
'fill-color': 'blue',
'fill-opacity': 0.25
}
});

map.addLayer({
'id': 'mask',
'type': 'fill',
"filter": ["!=", "iso_3166_1", val],
'source': 'mask',
'layout': {},
'paint': {
'fill-color': 'red',
'fill-opacity': 0.25
}
});

map.addSource('ne_populatedplaces', {
  type: 'geojson',
  data: 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_populated_places.geojson'
});

map.addLayer({
'id': 'ne_populatedplaces',
'type': 'circle',
'source': 'ne_populatedplaces',
'layout': {},
'paint': {
'circle-color': ['case', ['within', selectedgeom], 'blue', 'red'],
'circle-opacity' : 0.75,
'circle-radius': 
[
  "interpolate",
  ["linear"],
  ["get", "RANK_MAX"],
  0,
  0,
  14,
  5
]
},
});

map.addSource('streets', {
  type: 'vector',
  url: 'mapbox://mapbox.mapbox-streets-v8'
});

map.addLayer({
'id': 'streets',
'type': 'line',
'source': 'streets',
'source-layer': 'road',
'layout': {},
'paint': {
'line-color': ['case', ['within', selectedgeom], 'blue', 'red'],
'line-width' : 1,
'line-opacity': 0.75
}
});
});
});
});
</script>
</html>
