<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Nearby</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css" rel="stylesheet" />
<link href='https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.min.css' rel='stylesheet'>
<script src='https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<style>
body { margin: 0; padding: 0; }
#header { position: absolute; top: 0; height: 50px; background-color: #00B246; width: 100%; z-index: 1}

* {
  box-sizing: border-box;
}


.column {
  position: relative; 
  top: 50px;
  float: left;
  padding: 10px;
  height: calc(100vh - 50px);
  background-color: #F4F4F7;
}

.left, .right {
  width: 25%;
}

.middle {
  width: 50%;
}

.row:after {
  content: "";
  display: table;
  clear: both;
}
#map {
	  width: 100%;
      height: 75%;
      top: 0;
      margin: 0 auto;
      position: relative;
}

.marker {
  background-image: url('star.png');
  background-size: cover;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
}

#wrapper {
    float: left;
    width: 100%;
}

.listings {
        height: 50%;
        overflow: auto;
        padding-bottom: 60px;
      }

      .listings .item {
        display: block;
        border-bottom: 1px solid #eee;
        padding: 10px;
        text-decoration: none;
      }

      .listings .item:last-child {
        border-bottom: none;
      }
      .listings .item .title {
        display: block;
        color: #00853e;
        font-weight: 700;
      }

      .listings .item .title small {
        font-weight: 400;
      }
      .listings .item.active .title,
      .listings .item .title:hover {
        color: #8cc63f;
      }
      .listings .item.active {
        background-color: #f8f8f8;
      }
      ::-webkit-scrollbar {
        width: 3px;
        height: 3px;
        border-left: 0;
        background: rgba(0, 0, 0, 0.1);
      }
      ::-webkit-scrollbar-track {
        background: none;
      }
      ::-webkit-scrollbar-thumb {
        background: #00853e;
        border-radius: 0;
      }

#block {
font-size: large;
}

</style>
</head>

<body>
<div id="header"></div>

<div class="row">
  <div class="column left"></div>
  <div class="column middle">
  <div id="map"></div>
  <div id="wrapper">
  <div id="block">Within 500 meters we found the following Points of Interest:</div>
  <div id='listings' class='listings'></div>
</div>
</div>
  <div class="column right">
  </div>
</div>

</body> 
<script>


mapboxgl.accessToken = 'pk.eyJ1IjoiYWxsYW53YWxrZXIiLCJhIjoiY2phbHVlOHQ4MnZscDMycGJoaTdiaHRxOCJ9.OYLAoMVg6e3Ih4r65WJuvA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/allanwalker/ckb7cavi84uxf1io7wf78znx4?fresh=true',
        center: [-121.253,38.733],
        zoom: 14
    });

map.addControl(new mapboxgl.NavigationControl());

var el = document.createElement('div');
el.className = 'marker';

var marker = new mapboxgl.Marker({element: el,draggable: true})
    .setLngLat([-121.253,38.733])
    .addTo(map);
;

map.on('style.load', function() {

var lngLat = marker.getLngLat();
var lon = lngLat.lng;
var lat = lngLat.lat;
var limit = 50;
var radius = 500;
var query = 'https://api.mapbox.com/v4/mapbox.mapbox-streets-v8/tilequery/'+ lon + ',' + lat +'.json?radius='+ radius + '&layers=poi_label&dedupe=true&limit='+ limit +'&access_token='+ mapboxgl.accessToken;
var point = turf.point([lon,lat]);
var buffered = turf.buffer(point, radius * 2, {units: 'meters'});

var bbox = turf.bbox(buffered);

map.fitBounds(bbox, {
  padding: 100
});

map.addSource('buffer', { type: 'geojson', data: buffered });
map.addLayer({
   'id': 'buffer',
   'type': 'fill',
   'source': 'buffer',
   'layout': {},
   'paint': {
     'fill-color': '#5a3fc0',
     'fill-opacity': 0.5
   }
 }, "poi-label");
;

$.ajax({
    method: 'GET',
    url: query
  }).done(function(data) {
    map.getSource('poi').setData(data);
    var poi = data;



poi.features.forEach(function(poi, i){
    var prop = poi.properties;
    var options = { units: 'meters' };
Object.defineProperty(poi.properties, 'distance', {
    value: turf.distance(point, poi.geometry, options),
    writable: true,
    enumerable: true,
    configurable: true
  });
;
    var roundedDistance = Math.round(prop.distance * 100) / 100;
    var listings = document.getElementById('listings');
    var listing = listings.appendChild(document.createElement('div'));
    listing.id = "listing-" + prop.id;
    listing.className = 'item';
    var details = listing.appendChild(document.createElement('div'));
    details.innerHTML = prop.name +' | Distance: '+roundedDistance +' Meters';
  });
});

map.addSource('poi', { type: 'geojson',
   data: {
     'type': 'FeatureCollection',
     'features': []
   }
 });


map.addLayer({
   'id': 'poi',
   'type': 'circle',
   'source': 'poi',
   'layout': {},
   'paint': {
     'circle-color': ['case', ['within', buffered], '#5a3fc0', 'rgba(0,0,0,0)'],
     'circle-opacity': 1,
     'circle-radius': 5,
     'circle-stroke-width': 1,
     'circle-stroke-color': 'white'
   }
 }, "poi-label");
});

function onDragEnd() {
var lngLat = marker.getLngLat();
var lon = lngLat.lng;
var lat = lngLat.lat;
var limit = 50;
var radius = 500;
var query = 'https://api.mapbox.com/v4/mapbox.mapbox-streets-v8/tilequery/'+ lon + ',' + lat +'.json?radius='+ radius + '&layers=poi_label&dedupe=true&limit='+ limit +'&access_token='+ mapboxgl.accessToken;
var point = turf.point([lon,lat]);
var buffered = turf.buffer(point, radius * 2, {units: 'meters'});

var bbox = turf.bbox(buffered);

map.fitBounds(bbox, {
  padding: 100
});

if (map.getLayer('buffer')){
map.removeLayer('buffer');
map.removeSource('buffer');
}

if (map.getLayer('poi')){
map.removeLayer('poi');
map.removeSource('poi');
}

map.addSource('buffer', { type: 'geojson', data: buffered });

map.addLayer({
   'id': 'buffer',
   'type': 'fill',
   'source': 'buffer',
   'layout': {},
   'paint': {
     'fill-color': '#5a3fc0',
     'fill-opacity': 0.5
   }
 }, "poi-label");
;

$.ajax({
    method: 'GET',
    url: query
  }).done(function(data) {
    var poi = data;
    poi.features.forEach(function(poi, i){
    var prop = poi.properties;
    var options = { units: 'meters' };
Object.defineProperty(poi.properties, 'distance', {
    value: turf.distance(point, poi.geometry, options),
    writable: true,
    enumerable: true,
    configurable: true
  });
;
    var roundedDistance = Math.round(prop.distance * 100) / 100;
    $("#listings").empty();
    var listings = document.getElementById('listings');
    var listing = listings.appendChild(document.createElement('div'));
    listing.id = "listing-" + prop.id;
    listing.className = 'item';
    var details = listing.appendChild(document.createElement('div'));
    details.innerHTML = prop.name +' | Distance: '+roundedDistance +' Meters';

if (map.getLayer('newpoi')){
map.removeLayer('newpoi');
map.removeSource('newpoi');
}

map.addSource('newpoi', { type: 'geojson', data: poi });
map.addLayer({
   'id': 'newpoi',
   'type': 'circle',
   'source': 'newpoi',
   'layout': {},
   'paint': {
     'circle-color': ['case', ['within', buffered], '#5a3fc0', 'rgba(0,0,0,0)'],
     'circle-opacity': 1,
     'circle-radius': 5,
     'circle-stroke-width': 1,
     'circle-stroke-color': 'white'
   }
 }, "poi-label");
});

  });
};



marker.on('dragend', onDragEnd);






 

</script>
</html>
